<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ramallah Waste Containers</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <style>
    body {
      margin: 0;
      height: 100%;
      width: 100%;
    }
    #map {
      position: absolute;
      width: 100%;
      top: 0;
      bottom: 0;
    }
    #searchBox {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    #findNearest {
      position: absolute;
      top: 60px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <input type="text" id="searchBox" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø©..." />
  <button id="findNearest">ğŸ“ Ø£Ù‚Ø±Ø¨ Ø­Ø§ÙˆÙŠØ©</button>

  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <script>
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    const map = L.map("map", {
      zoomSnap: 0.5,
      center: [31.9045, 35.2045],
      zoom: 16.5,
    });

    // Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø³Ø§Ø³
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap & CARTO',
      subdomains: 'abcd',
      maxZoom: 20
    }).addTo(map);

    // Ø¥Ø¶Ø§ÙØ© Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„Ø±Ø³Ù…
    L.control.scale({ metric: true, imperial: false }).addTo(map);

    // Ø·Ø¨Ù‚Ø§Øª
    let wasteCluster = L.markerClusterGroup();
    let wasteContainers = [];
    let zonesLayer;

    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª
    $.getJSON("wasteContainer.json", function(WC) {
      const layer = L.geoJson(WC, {
        pointToLayer: function(feature, latlng) {
          // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„Ø§Ù…ØªÙ„Ø§Ø¡
          let level = feature.properties.fillLevel || 0;
          let color = level > 80 ? "red" : level > 50 ? "orange" : "green";

          let marker = L.circleMarker(latlng, {
            radius: 6,
            fillColor: color,
            color: color,
            weight: 1,
            opacity: 1,
            fillOpacity: 0.9
          });

          marker.bindPopup(`
            <b>Container ID:</b> ${feature.properties.id || 'N/A'}<br>
            <b>Fill Level:</b> ${level}%<br><br>
            <input type="file" accept="image/*" onchange="uploadPhoto(event, '${feature.properties.id}')">
            <p id="photo-${feature.properties.id}" style="margin-top:5px;"></p>
          `);

          wasteContainers.push(latlng);
          return marker;
        }
      });
      wasteCluster.addLayer(layer);
      map.addLayer(wasteCluster);
    });

    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
    $.getJSON("RamallahZones.json", function(RZ) {
      zonesLayer = L.geoJson(RZ, {
        style: {
          fillColor: "yellow",
          fillOpacity: 0.2,
          color: "yellow",
          weight: 1.0,
          opacity: 0.7
        },
        onEachFeature: function(feature, layer) {
          layer.bindPopup(`<b>${feature.properties.NAME_ENGLI}</b><br>MAIL_CODE: ${feature.properties.MAIL_CODE}`);
        }
      }).addTo(map);

      // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…
      const searchBox = document.getElementById("searchBox");
      searchBox.addEventListener("keyup", function(e) {
        let text = e.target.value.toLowerCase();
        zonesLayer.eachLayer(function(layer) {
          let name = layer.feature.properties.NAME_ENGLI.toLowerCase();
          if (name.includes(text) && text.length > 0) {
            map.fitBounds(layer.getBounds());
            layer.openPopup();
          }
        });
      });
    });

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ø£Ù‚Ø±Ø¨ Ø­Ø§ÙˆÙŠØ©
    document.getElementById("findNearest").addEventListener("click", () => {
      map.locate({ setView: true, maxZoom: 18 });
    });

    map.on('locationfound', function(e) {
      const userLocation = e.latlng;
      let nearest = null;
      let minDist = Infinity;

      wasteContainers.forEach(point => {
        const dist = userLocation.distanceTo(point);
        if (dist < minDist) {
          minDist = dist;
          nearest = point;
        }
      });

      if (nearest) {
        L.marker(userLocation).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ").openPopup();
        L.polyline([userLocation, nearest], { color: "lime", dashArray: "5,5" }).addTo(map);
        L.popup()
          .setLatLng(nearest)
          .setContent("Ø£Ù‚Ø±Ø¨ Ø­Ø§ÙˆÙŠØ© ØªØ¨Ø¹Ø¯ " + (minDist).toFixed(1) + " Ù…ØªØ±")
          .openOn(map);
      }
    });

    map.on('locationerror', () => alert("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ ğŸ˜•"));

    // Ø±ÙØ¹ ØµÙˆØ±Ø© Ù„Ù„Ø­Ø§ÙˆÙŠØ©
    function uploadPhoto(event, containerId) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById(`photo-${containerId}`).innerHTML =
            `<img src="${e.target.result}" width="100" style="border-radius:8px;">`;
        };
        reader.readAsDataURL(file);
        alert("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!");
      }
    }
  </script>
</body>
</html>
