<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>Ramallah Waste Containers 3D</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://unpkg.com/maplibre-gl@2.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body, html { margin:0; padding:0; height:100%; width:100%; }
    #map { width:100%; height:100%; }
    .map-overlay {
      position: absolute;
      background: rgba(255,255,255,0.8);
      padding: 5px;
      border-radius: 5px;
      z-index: 9999;
    }
    #geocoder-container { top:10px; left:10px; width:250px; }
    #north-arrow { top:80px; left:10px; }
    #toggle3D { top:10px; right:10px; cursor:pointer; }
    .upload-image { max-width: 100%; margin-top: 5px; border-radius:5px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="map-overlay" id="geocoder-container">
    <input type="text" id="searchBox" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...">
  </div>
  <div class="map-overlay" id="north-arrow">
    <img src="https://upload.wikimedia.org/wikipedia/commons/0/09/Compass_rose_simple.svg" width="50">
  </div>
  <div class="map-overlay" id="toggle3D">ğŸ›°ï¸ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¬ÙˆØ§Ù„ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</div>

  <script src="https://unpkg.com/maplibre-gl@2.6.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@mapbox/mapbox-gl-geocoder@4.7.0/dist/mapbox-gl-geocoder.min.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

  <script>
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://api.maptiler.com/maps/satellite/style.json?key=pLIV6Yf4t59Pr1wM2d5r',
      center: [35.2045,31.9045],
      zoom: 17,
      pitch: 60, // Ø²Ø§ÙˆÙŠØ© Ø§Ù„ØªØ¬ÙˆØ§Ù„
      bearing: -17
    });

    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    // Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„Ø±Ø³Ù… Ø¨Ø§Ù„Ù…ØªØ± ÙÙ‚Ø·
    map.addControl(new maplibregl.ScaleControl({ maxWidth: 200, unit: 'metric' }), 'bottom-left');

    // Ø§Ù„Ø¨Ø­Ø«
    const searchInput = document.getElementById('searchBox');
    searchInput.addEventListener('keyup', function(e){
      if(e.key === 'Enter') {
        const query = searchInput.value.toLowerCase();
        map.getSource('zones') && map.setFilter('zones-fill', ['==', ['downcase', ['get', 'NAME_ENGLI']], query]);
      }
    });

    // ØªØ­Ù…ÙŠÙ„ Ù…Ù†Ø§Ø·Ù‚ Ø±Ø§Ù… Ø§Ù„Ù„Ù‡
    map.on('load', function() {
      axios.get('RamallahZones.json').then(res => {
        map.addSource('zones', {
          type:'geojson',
          data: res.data
        });
        map.addLayer({
          id:'zones-fill',
          type:'fill',
          source:'zones',
          paint:{ 'fill-color':'yellow', 'fill-opacity':0.3 }
        });
        map.addLayer({
          id:'zones-line',
          type:'line',
          source:'zones',
          paint:{ 'line-color':'yellow', 'line-width':2 }
        });
      });

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª
      axios.get('wasteContainer.json').then(res=>{
        const features = res.data.features.map(f=>{
          return {
            type:'Feature',
            geometry:f.geometry,
            properties:{
              area: f.properties.zone_name || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
              type: f.properties.container_type || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
              postal: f.properties.postal_code || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"
            }
          };
        });

        map.addSource('containers', {
          type:'geojson',
          data:{ type:'FeatureCollection', features: features },
          cluster:true,
          clusterMaxZoom: 18,
          clusterRadius:50
        });

        map.addLayer({
          id:'clusters',
          type:'circle',
          source:'containers',
          filter:['has','point_count'],
          paint:{ 'circle-color':'orange', 'circle-radius':20 }
        });

        map.addLayer({
          id:'cluster-count',
          type:'symbol',
          source:'containers',
          filter:['has','point_count'],
          layout:{ 'text-field':'{point_count_abbreviated}','text-size':12 }
        });

        map.addLayer({
          id:'unclustered-point',
          type:'circle',
          source:'containers',
          filter:['!has','point_count'],
          paint:{ 'circle-color':'orange', 'circle-radius':6 }
        });

        // Popup
        map.on('click','unclustered-point',function(e){
          const props = e.features[0].properties;
          const coordinates = e.features[0].geometry.coordinates.slice();
          const popupNode = document.createElement('div');
          popupNode.innerHTML = `
            <b>Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</b> ${props.area}<br>
            <b>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ©:</b> ${props.type}<br>
            <b>Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠ:</b> ${props.postal}<br>
            <label>Ø£Ø¶Ù ØµÙˆØ±Ø© Ù„Ù„Ø­Ø§ÙˆÙŠØ©:</label>
            <input type="file" accept="image/*" onchange="showImage(event)">
            <img id="uploadedImage" class="upload-image" style="display:none;">
          `;
          new maplibregl.Popup()
            .setLngLat(coordinates)
            .setDOMContent(popupNode)
            .addTo(map);
        });
      });
    });

    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Popup
    function showImage(event){
      const file = event.target.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = function(e){
          const img = document.getElementById("uploadedImage");
          img.src = e.target.result;
          img.style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    }

    // Ø§Ù„ØªØ¬ÙˆØ§Ù„ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ (ØªÙØ¹ÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù)
    let is3D = true;
    document.getElementById('toggle3D').addEventListener('click', ()=>{
      if(is3D){
        map.easeTo({pitch:0,bearing:0});
        document.getElementById('toggle3D').innerText="ğŸ›°ï¸ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¬ÙˆØ§Ù„ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ";
        is3D=false;
      }else{
        map.easeTo({pitch:60,bearing:-17});
        document.getElementById('toggle3D').innerText="ğŸ—ºï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ¬ÙˆØ§Ù„ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ";
        is3D=true;
      }
    });
  </script>
</body>
</html>
