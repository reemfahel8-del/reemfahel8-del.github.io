<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ramallah Waste Containers</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

  <!-- Search Control CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-search/dist/leaflet-search.min.css" />

  <style>
    body { margin: 0; height: 100%; width: 100%; }
    #map { position: absolute; width: 100%; height: 100%; top: 0; bottom: 0; }
    .search-control {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- JS Libraries -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet-control-search/dist/leaflet-search.min.js"></script>

  <script>
    const map = L.map("map", {
      center: [31.9045, 35.2045],
      zoom: 17,
      zoomSnap: 0.5
    });

    // Base Map
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
      subdomains: 'abcd',
      maxZoom: 20
    }).addTo(map);

    // مقياس الرسم
    L.control.scale({ metric: true, imperial: false }).addTo(map);

    // تحميل المناطق
    let zonesLayer;
    $.getJSON("RamallahZones.json", function(RZ) {
      zonesLayer = L.geoJson(RZ, {
        style: { fillColor: "yellow", fillOpacity: 0.3, color: "yellow", weight: 1, opacity: 0.7 },
        onEachFeature: function(feature, layer) {
          layer.bindPopup("Zone: " + feature.properties.NAME_ENGLI + "<br>MAIL_CODE: " + feature.properties.MAIL_CODE);
        }
      }).addTo(map);

      // بحث باسم المنطقة
      const searchControl = new L.Control.Search({
        layer: zonesLayer,
        propertyName: 'NAME_ENGLI',
        marker: false,
        moveToLocation: function(latlng, title, map) {
          map.setView(latlng, 17);
        }
      });
      map.addControl(searchControl);
    });

    // تحميل الحاويات
    let wasteContainersLayer;
    $.getJSON("wasteContainer.json", function(WC) {
      const markers = L.markerClusterGroup();

      wasteContainersLayer = L.geoJson(WC, {
        pointToLayer: function(feature, latlng) {
          const fullness = feature.properties.fullness || 0; // نسبة الامتلاء
          let color = fullness < 30 ? "green" : fullness < 70 ? "orange" : "red";

          const marker = L.circleMarker(latlng, {
            radius: 7,
            fillColor: color,
            color: "#fff",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.9
          });

          // إضافة الصورة من المستخدم
          let imgHTML = "";
          marker.on("click", function() {
            const popupContent = `
              <b>Container ID:</b> ${feature.properties.id || "N/A"}<br>
              <b>Fullness:</b> ${fullness}%<br>
              <div>${imgHTML}</div>
              <br>
              <input type="file" id="imgInput" accept="image/*"><br>
              <button id="uploadBtn">Add Image</button>
            `;
            marker.bindPopup(popupContent).openPopup();

            setTimeout(() => {
              const uploadBtn = document.getElementById("uploadBtn");
              if (uploadBtn) {
                uploadBtn.onclick = () => {
                  const fileInput = document.getElementById("imgInput");
                  if (fileInput.files.length > 0) {
                    const reader = new FileReader();
                    reader.onload = e => {
                      imgHTML = `<img src="${e.target.result}" width="150px">`;
                      marker.setPopupContent(`
                        <b>Container ID:</b> ${feature.properties.id || "N/A"}<br>
                        <b>Fullness:</b> ${fullness}%<br>
                        <div>${imgHTML}</div>
                      `);
                    };
                    reader.readAsDataURL(fileInput.files[0]);
                  }
                };
              }
            }, 500);
          });

          return marker;
        }
      });

      markers.addLayer(wasteContainersLayer);
      map.addLayer(markers);

      // إيجاد أقرب حاوية من موقع المستخدم
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          const userLatLng = L.latLng(pos.coords.latitude, pos.coords.longitude);
          L.marker(userLatLng).addTo(map).bindPopup("موقعك الحالي").openPopup();

          let minDist = Infinity;
          let nearest = null;

          wasteContainersLayer.eachLayer(function(layer) {
            const dist = userLatLng.distanceTo(layer.getLatLng());
            if (dist < minDist) {
              minDist = dist;
              nearest = layer;
            }
          });

          if (nearest) {
            L.polyline([userLatLng, nearest.getLatLng()], { color: 'cyan', dashArray: '5,5' }).addTo(map);
            L.popup()
              .setLatLng(nearest.getLatLng())
              .setContent(`أقرب حاوية تبعد ${(minDist / 1000).toFixed(2)} كم`)
              .openOn(map);
          }
        });
      }
    });
  </script>
</body>
</html>
