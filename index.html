<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Ramallah Waste Containers 3D</title>

<!-- Mapbox GL CSS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.20.0/mapbox-gl.css" rel="stylesheet" />
<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>
<body>
<div id="map"></div>

<!-- Mapbox GL JS -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.20.0/mapbox-gl.js"></script>

<!-- Mapbox GL Geocoder -->
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.2/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.2/mapbox-gl-geocoder.css" type="text/css"/>

<script>
  // ضع توكن Mapbox الخاص بك هنا
  mapboxgl.accessToken = 'YOUR_MAPBOX_TOKEN';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v11',
    center: [35.2045, 31.9045],
    zoom: 17,
    pitch: 60,  
    bearing: -17.6,
    antialias: true
  });

  // التحكم بالتكبير والتدوير
  map.addControl(new mapboxgl.NavigationControl());

  // Search
  map.addControl(new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    mapboxgl: mapboxgl,
    placeholder: "Search Zone",
    marker: false
  }), 'top-right');

  map.on('load', () => {
    // Scale بالمتر
    map.addControl(new mapboxgl.ScaleControl({ maxWidth: 200, unit: 'metric' }));

    // تحميل المناطق (Zones) من ملف محلي
    fetch('RamallahZones.json')
      .then(res => res.json())
      .then(RZ => {
        map.addSource('zones', { type: 'geojson', data: RZ });
        map.addLayer({
          id: 'zones-fill',
          type: 'fill',
          source: 'zones',
          paint: { 'fill-color': 'yellow', 'fill-opacity': 0.3 }
        });
        map.addLayer({
          id: 'zones-line',
          type: 'line',
          source: 'zones',
          paint: { 'line-color': 'yellow', 'line-width': 2 }
        });
      });

    // تحميل الحاويات (Waste Containers) من ملف محلي
    fetch('wasteContainer.json')
      .then(res => res.json())
      .then(WC => {
        map.addSource('waste', {
          type: 'geojson',
          data: WC,
          cluster: true,
          clusterMaxZoom: 18,
          clusterRadius: 50
        });

        // Cluster circles
        map.addLayer({
          id: 'clusters',
          type: 'circle',
          source: 'waste',
          filter: ['has', 'point_count'],
          paint: {
            'circle-color': '#FF8C00',
            'circle-radius': [
              'step',
              ['get', 'point_count'],
              15, 10,
              20, 50,
              25
            ],
            'circle-opacity': 0.8
          }
        });

        // Cluster count labels
        map.addLayer({
          id: 'cluster-count',
          type: 'symbol',
          source: 'waste',
          filter: ['has', 'point_count'],
          layout: { 'text-field': '{point_count_abbreviated}', 'text-size': 12 }
        });

        // Individual markers
        map.addLayer({
          id: 'unclustered-point',
          type: 'circle',
          source: 'waste',
          filter: ['!', ['has', 'point_count']],
          paint: {
            'circle-color': 'orange',
            'circle-radius': 6,
            'circle-stroke-width': 1,
            'circle-stroke-color': '#fff'
          }
        });

        // Popup لكل حاوية
        map.on('click', 'unclustered-point', (e) => {
          const coordinates = e.features[0].geometry.coordinates.slice();
          const { zone_name, container_type } = e.features[0].properties;
          new mapboxgl.Popup()
            .setLngLat(coordinates)
            .setHTML(`<b>Zone:</b> ${zone_name}<br><b>Type:</b> ${container_type}`)
            .addTo(map);
        });

        // Zoom عند الضغط على Cluster
        map.on('click', 'clusters', (e) => {
          const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
          const clusterId = features[0].properties.cluster_id;
          map.getSource('waste').getClusterExpansionZoom(clusterId, (err, zoom) => {
            if (err) return;
            map.easeTo({ center: features[0].geometry.coordinates, zoom: zoom });
          });
        });

        // Cursor pointer
        map.on('mouseenter', 'clusters', () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', 'clusters', () => map.getCanvas().style.cursor = '');
        map.on('mouseenter', 'unclustered-point', () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', 'unclustered-point', () => map.getCanvas().style.cursor = '');
      });
  });
</script>
</body>
</html>
