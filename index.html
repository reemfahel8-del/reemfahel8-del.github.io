<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>Ramallah Waste Containers</title>

  <!-- Ù…ÙƒØªØ¨Ø§Øª Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

  <style>
    body { margin: 0; height: 100%; width: 100%; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    .leaflet-control-geocoder {
      position: absolute !important;
      right: 15px;
      top: 10px;
      z-index: 9999;
      width: 280px;
    }
    .upload-btn {
      display: block;
      margin-top: 5px;
      color: #0078ff;
      text-decoration: underline;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Ù…ÙƒØªØ¨Ø§Øª JavaScript -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/leaflet.globe.min.js"></script>

  <script>
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    const mapOptions = {
      zoomSnap: 0.5,
      center: [31.9045, 35.2045],
      zoom: 16
    };
    const map = L.map("map", mapOptions);

    // Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    const baseMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap & CARTO',
      subdomains: 'abcd',
      maxZoom: 20
    }).addTo(map);

    // Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„Ø±Ø³Ù… Ø¨Ø§Ù„Ù…ØªØ±
    L.control.scale({ metric: true, imperial: false }).addTo(map);

    // Ø£Ø¯Ø§Ø© Ø§Ù„Ø¨Ø­Ø« (Geocoder)
    L.Control.geocoder({
      defaultMarkGeocode: true,
      placeholder: "Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...",
    }).addTo(map);

    // Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    map.locate({ setView: true, maxZoom: 17 });
    map.on('locationfound', e => {
      L.marker(e.latlng).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ").openPopup();
    });

    // Ø·Ø¨Ù‚Ø© Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ù„Ù„Ø­Ø§ÙˆÙŠØ§Øª
    const containerClusters = L.markerClusterGroup();
    let previousMarker = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø¢Ø®Ø± Ø­Ø§ÙˆÙŠØ© ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡Ø§

    // Ø³Ø±Ø¹Ø© Ø¹Ø§Ù…Ù„ Ø§Ù„Ù†Ø¸Ø§ÙØ© (Ù…ØªØ±/Ø«Ø§Ù†ÙŠØ©)
    const workerSpeed = 1.5;

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª
    $.getJSON("wasteContainer.json", function (WC) {
      const wasteContainersLayer = L.geoJson(WC, {
        pointToLayer: function (feature, latlng) {
          // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ÙˆÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø§Ù…ØªÙ„Ø§Ø¡
          let fill = "green";
          if (feature.properties.FillLevel >= 70) fill = "red";
          else if (feature.properties.FillLevel >= 40) fill = "yellow";

          const marker = L.circleMarker(latlng, {
            radius: 7,
            fillColor: fill,
            color: "#222",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.9
          });

          // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§ÙˆÙŠØ©
          marker.on('click', function () {
            const content = `
              <b>Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</b> ${feature.properties.Area}<br>
              <b>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ©:</b> ${feature.properties.Type}<br>
              <b>Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù…ØªÙ„Ø§Ø¡:</b> ${feature.properties.FillLevel}%<br>
              <span class="upload-btn" onclick="uploadImage()">ğŸ“¸ Ø£Ø¶Ù ØµÙˆØ±Ø© Ù„Ù„Ø­Ø§ÙˆÙŠØ©</span>
            `;
            marker.bindPopup(content).openPopup();

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„Ø²Ù…Ù† Ù…Ù† Ø¢Ø®Ø± Ø­Ø§ÙˆÙŠØ©
            if (previousMarker) {
              const distance = map.distance(previousMarker.getLatLng(), marker.getLatLng());
              const time = (distance / workerSpeed).toFixed(1);
              alert(`Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø­Ø§ÙˆÙŠØªÙŠÙ†: ${distance.toFixed(1)} Ù…ØªØ±\nØ§Ù„Ø²Ù…Ù† Ø§Ù„Ù„Ø§Ø²Ù…: ${time} Ø«Ø§Ù†ÙŠØ©`);
            }
            previousMarker = marker;
          });
          return marker;
        }
      });
      containerClusters.addLayer(wasteContainersLayer);
      map.addLayer(containerClusters);
    });

    // ØªØ­Ù…ÙŠÙ„ Ù…Ù†Ø§Ø·Ù‚ Ø±Ø§Ù… Ø§Ù„Ù„Ù‡
    $.getJSON("RamallahZones.json", function (RZ) {
      L.geoJson(RZ, {
        style: { fillColor: "yellow", fillOpacity: 0.3, color: "yellow", weight: 1 },
        onEachFeature: function (feature, layer) {
          layer.bindPopup(`<b>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</b> ${feature.properties.NAME_ENGLI}<br><b>Ø§Ù„ÙƒÙˆØ¯:</b> ${feature.properties.MAIL_CODE}`);
        }
      }).addTo(map);
    });

    // ÙˆØ¸ÙŠÙØ© Ø±ÙØ¹ ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    window.uploadImage = function () {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) alert(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø©: ${file.name}`);
      };
      input.click();
    };

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
    L.globe(map);
  </script>
</body>
</html>
